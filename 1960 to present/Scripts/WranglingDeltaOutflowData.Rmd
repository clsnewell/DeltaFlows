---
title: "Exports and Inflow to the Delta"
author: "Caroline Newell"
date: "2/1/2022"
output: word_document
editor_options: 
  chunk_output_type: console
---
Hi Caroline, I have a small task for you. Could you generate a graph of Exports and Inflow to the Delta using data from this website? https://www.usbr.gov/mp/cvo/pmdoc.html
Attached is a version of the kind of plot we would like--we just need an update. It doesn't have to look exactly like this by any means, we just need to show the relationship. Also attached is a spreadsheet showing last year's values (downloaded from that website--we just need the longer time series, dating from the 60s, and a nice plot.  Thank you!
john

John's website sucked. Better option: https://data.cnra.ca.gov/dataset/dayflow
```{r}
library(readr)
library(tidyverse)
library(lubridate)
library(ggplot2)
library(lfstat)
#install_github("ChandlerLutz/ggts")
```

#Reading al of the data in, formatting, writing

```{r}
dayflow_results_1956_1969 <- read_csv("C:/Users/cnewe/OneDrive/Documents/Delta Inflow Outflow/1960 to present/data/dayflow-results-1956-1969.csv")
dayflow_results_1970_1983 <- read_csv("C:/Users/cnewe/OneDrive/Documents/Delta Inflow Outflow/1960 to present/data/dayflow-results-1970-1983.csv")
dayflow_results_1984_1996 <- read_csv("C:/Users/cnewe/OneDrive/Documents/Delta Inflow Outflow/1960 to present/data/dayflow-results-1984-1996.csv")
dayflow_results_1997_2020 <- read_csv("C:/Users/cnewe/OneDrive/Documents/Delta Inflow Outflow/1960 to present/data/dayflow-results-1997-2020.csv")
dayflowcalculations2021 <- read_csv("C:/Users/cnewe/OneDrive/Documents/Delta Inflow Outflow/1960 to present/data/dayflowcalculations2021.csv")
```

Now I need to join all of the data together into one dataframe.

```{r}
#str(dayflowcalculations2021$Date)
#dayflowcalculations2021$Date<-mdy(dayflowcalculations2021$Date) #This deletes values for some reason, and date data appears to be correct already... so i'm gonna leave it.
                                               dayflow_results_1997_2020$Date<-mdy(dayflow_results_1997_2020$Date)

#str(dayflow_results_1984_1996) #Date is saved as a character, but when i do as.date it changes the value completely...                                                                                             
dayflow_results_1984_1996$Date<-mdy(dayflow_results_1984_1996$Date)
#str(dayflow_results_1984_1996$Date)
                                                  dayflow_results_1970_1983$Date<- mdy(dayflow_results_1970_1983$Date)
                                                    dayflow_results_1956_1969$Date<- mdy(dayflow_results_1956_1969$Date)
                                                    
#Need to pull out only relevant columns since all columns don't match between data sets. 

dayflowcalculations2021_subset<- dayflowcalculations2021[ , c('Date', 'TOT', 'EXPORTS', 'OUT')]  #how to subset with base r                                                  
dayflow_results_1997_2020_subset<-dayflow_results_1997_2020 %>% select(Date, TOT, EXPORTS, OUT) #how to subset using tidyverse

dayflow_results_1984_1996_subset<-dayflow_results_1984_1996 %>% select(Date, TOT, EXPORT, OUT)
#need to rename EXPORT -> EXPORTS
dayflow_results_1984_1996_subset<-dayflow_results_1984_1996_subset %>% rename(EXPORTS = EXPORT)
str(dayflow_results_1984_1996_subset)

dayflow_results_1970_1983_subset<-dayflow_results_1970_1983 %>% select(Date, TOT, EXPORT, OUT)
#need to rename EXPORT -> EXPORTS
dayflow_results_1970_1983_subset<- dayflow_results_1970_1983_subset %>% rename(EXPORTS = EXPORT)
str(dayflow_results_1970_1983_subset)

dayflow_results_1956_1969_subset<- dayflow_results_1956_1969 %>% select(Date, TOT, EXPORT, OUT)
#need to rename EXPORT -> EXPORTS
dayflow_results_1956_1969_subset<-dayflow_results_1956_1969_subset %>% rename(EXPORTS = EXPORT)

#okay, now I think we are ready to bind!

DeltaFlow1956_2021<- bind_rows(dayflow_results_1956_1969_subset, dayflow_results_1970_1983_subset, dayflow_results_1984_1996_subset, dayflow_results_1997_2020_subset, dayflowcalculations2021_subset)

#View(DeltaFlow1956_2021) #Dopenessss
str(DeltaFlow1956_2021)
```

```{r}
#Now I only want WATER YEAR 1960 through 2021.
DeltaFlow1960_2021<- DeltaFlow1956_2021 %>% filter(Date >="1959-10-01")
#View(DeltaFlow1960_2021)
#Save that shit!
write.csv(DeltaFlow1960_2021, "C:/Users/cnewe/OneDrive/Documents/Delta Inflow Outflow/1960 to present/data/DeltaFlow_WaterYears1960_2021.csv")
```

# Now we plot
```{r}
#basic bubble plots
ggplot(DeltaFlow1960_2021, aes(x=Date, y=TOT)) +
  geom_line() +
  xlab("")+
  ylab("Inflow")

ggplot(DeltaFlow1960_2021, aes(x=Date, y=EXPORTS)) +
  geom_line() +
  xlab("")+
  ylab("Exports")

ggplot(DeltaFlow1960_2021, aes(x=Date)) +
  geom_line(aes(y=TOT), color = "steelblue") +
  geom_line(aes(y=EXPORTS), color = "darkred", linetype = "twodash") +
  xlab("Water Year") +
  theme(legend.position = c(.95, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6))

#Wont make a legend :( Gotta collapse the two variables into key-value pairs and then visualize

df<- DeltaFlow1960_2021 %>% 
  select(Date, TOT, EXPORTS) %>% 
  gather(key="variable", value = "value", -Date)
head(df)

ggplot(df, aes(x=Date, y=value))+
  geom_line(aes(color = variable)) +
  scale_color_manual(values = c("darkred", "steelblue"))+
  facet_wrap(~variable, scales = "free")
```

John's response: You are close! There is so much noise that it makes it hard to read a signal. Try summing up by years, then create a stacked plot on one axis in MAF and see if we can get some traction.

```{r}
#sum by water year
df <- DeltaFlow1960_2021 %>% mutate(WaterYear = water_year(Date, origin = "usgs")) #That was so easy! Crying.
#Here is the code info for what I ran/how I did that: https://www.rdocumentation.org/packages/lfstat/versions/0.9.4/topics/water_year

#DeltaFlow1960_2021_year<-df %>% mutate(Year = year(Date)) %>% group_by(Year) %>% summarise(Exports_AvgCFS = sum(EXPORTS)/1000000, TOT_AvgCFS = sum(TOT)/1000000) #lovely. This gives avg cfs though and I want MAF...

DeltaFlow1960_2021_WaterYear<-df %>% group_by(WaterYear) %>% summarise(Exports_MAF = sum(EXPORTS*1.983)/1000000, TOT_MAF = sum(TOT*1.983)/1000000) #24 hours at 1 cfs  = 1.983 acre feet

DeltaFlow1960_2021_WaterYear$WaterYear<- as.Date(as.character(DeltaFlow1960_2021_WaterYear$WaterYear), format="%Y")

drought_years<-c(1976, 1977, 1987, 1988, 1989, 1990, 1991, 1992, 2007, 2008, 2009, 2012, 2013, 2014, 2015, 2016, 2020, 2021) #data from: https://water.ca.gov/water-basics/drought  and Peter (2020, 2021)

ggplot(DeltaFlow1960_2021_WaterYear, aes(x=WaterYear))+
  geom_bar(aes(y=TOT_MAF), stat="identity", color="black", fill="steelblue")+
  geom_line(aes(y=Exports_MAF, group =1), color="red", size=1.1) +
  xlab("Water Year") + ylab("MAF")

  #scale_x_continuous(name="Water Year", limits=c(1960, 2021))
  #theme(axis.text.x = element_text(angle=90, hjust=1))
  
#Adding drought to background

#shade<- data.frame(x1= as.Date(c("1975-10-01", "1986-10-01", "2006-10-01", "2011-10-01")), x2= as.Date(c("1977-09-30", "1992-09-30", "2009-09-30", "2016-09-30")) , y1= -Inf, y2= Inf)
#str(shade)

#t <- DeltaFlow1960_2021_WaterYear

DeltaFlow1960_2021_WaterYear$WaterYear <- lubridate::year(DeltaFlow1960_2021_WaterYear$WaterYear)

str(DeltaFlow1960_2021_WaterYear)
#Export trend line:
ggplot(DeltaFlow1960_2021_WaterYear, aes(x=WaterYear)) +geom_rect(aes(xmin=1976, xmax=1977, ymin=0, ymax=Inf), fill = "grey75", alpha = .1) +
  geom_rect(aes(xmin=1987, xmax=1992, ymin=0, ymax=Inf),fill = "grey75", alpha = .1) +
  geom_rect(aes(xmin=2007, xmax=2009, ymin=0, ymax=Inf),fill = "grey75", alpha = .1) +
  geom_rect(aes(xmin=2012, xmax=2016, ymin=0, ymax=Inf),fill = "grey75", alpha = .1)+
  geom_bar(aes(y=TOT_MAF), stat="identity", color="black", fill="steelblue") + 
  geom_line(aes(y=Exports_MAF, group =1), color="red", size=1.1) + xlab("Water Year") +  ylab("MAF") + ggtitle("Total Delta Inflow and Exports")+ scale_x_continuous(breaks=c(1960, 1970, 1980, 1990, 2000, 2010, 2020))+
  theme_classic(base_size=16) 

#Export bars: 
ggplot(DeltaFlow1960_2021_WaterYear, aes(x=WaterYear)) +geom_rect(aes(xmin=1976, xmax=1977, ymin=0, ymax=Inf), fill = "grey75", alpha = .1) +
  geom_rect(aes(xmin=1987, xmax=1992, ymin=0, ymax=Inf),fill = "grey75", alpha = .1) +
  geom_rect(aes(xmin=2007, xmax=2009, ymin=0, ymax=Inf),fill = "grey75", alpha = .1) +
  geom_rect(aes(xmin=2012, xmax=2016, ymin=0, ymax=Inf),fill = "grey75", alpha = .1)+
  geom_rect(aes(xmin=2020, xmax=2021, ymin=0, ymax=Inf),fill = "grey75", alpha = .1)+
  geom_bar(aes(y=TOT_MAF), stat="identity", color="black", fill="steelblue") + 
  geom_bar(aes(y=Exports_MAF), stat="identity", color="black", fill="red") + xlab("Water Year") +  ylab("MAF") + ggtitle("Total Delta Inflow and Exports")+ scale_x_continuous(breaks=c(1960, 1970, 1980, 1990, 2000, 2010, 2020))+
  theme_classic(base_size=16) 


```

John's response:
Thanks for checking the effect of WY. I'm reasonable confident that the line+circles on the old plot is Delta Inflow (or QTOT). Could the blue + red colors be export across the two pumping facilities?

Anyway, I prefer your plot. Would you like to send these to Peter with a short explanation? Send one with the trend line and one with the stacked bars for Export. And could you use 10 yr increments on the x axis?
Nicely done. 
For fun, will you try one more thing? Using the stacked bar plot, can you plot the mean annual location of X2 across the time series? For this, you will need a second axis. If you get stuck, let me know.